# IÄŒO & Invoice Extractor Configuration

This application requires API keys to function.

## 1. Get Your Keys

### Google Gemini API
- **Link**: [https://aistudio.google.com/app/apikey](https://aistudio.google.com/app/apikey)
- **Key**: `API_KEY`

### Supabase
- **Link**: [https://supabase.com/dashboard](https://supabase.com/dashboard) -> Select Project -> Project Settings -> API
- **URL**: `SUPABASE_URL`
- **Key**: `SUPABASE_ANON_KEY` (use the `anon public` key)

---

## 2. Local Development Setup

1. Create a file named `.env` in the root directory.
2. Paste your keys:
   ```bash
   API_KEY=your_gemini_key
   SUPABASE_URL=your_supabase_url
   SUPABASE_ANON_KEY=your_supabase_anon_key
   ```
3. Run `npm run dev`.

---

## 3. Deployment on Render.com

Since you cannot upload `.env` files to Render, you must set them in the dashboard.

1. Go to your **Render Dashboard**.
2. Select your Service.
3. Click **Environment** in the left sidebar.
4. Click **Add Environment Variable**.
5. Add all 3 keys (`API_KEY`, `SUPABASE_URL`, `SUPABASE_ANON_KEY`).
6. **Trigger a new deployment** (Manual Deploy -> Clear Cache & Deploy) so the build process can read these variables.

---

## 4. Database Setup (SQL)

Copy and run the following script in your **Supabase SQL Editor** to set up all tables and permissions.

```sql
-- 1. CLEANUP
DROP FUNCTION IF EXISTS claim_invited_role() CASCADE;

-- 2. CREATE ENUM (Safely)
DO $$ 
BEGIN
    IF NOT EXISTS (SELECT 1 FROM pg_type WHERE typname = 'project_role') THEN
        CREATE TYPE project_role AS ENUM ('lineproducer', 'producer', 'accountant');
    END IF;
END $$;

-- 3. CREATE TABLES

-- Profiles
CREATE TABLE IF NOT EXISTS profiles (
  id uuid references auth.users on delete cascade primary key,
  email text,
  full_name text,
  is_superuser boolean default false,
  is_disabled boolean default false,
  created_at timestamp with time zone default timezone('utc'::text, now()) not null
);

-- Projects
CREATE TABLE IF NOT EXISTS projects (
  id bigint generated by default as identity primary key,
  name text not null,
  created_at timestamp with time zone default timezone('utc'::text, now()) not null
);

-- Budgets
CREATE TABLE IF NOT EXISTS budgets (
  id bigint generated by default as identity primary key,
  project_id bigint references projects on delete cascade,
  version_name text,
  xml_content text,
  created_at timestamp with time zone default timezone('utc'::text, now()) not null
);

-- Project Assignments
CREATE TABLE IF NOT EXISTS project_assignments (
  id bigint generated by default as identity primary key,
  project_id bigint references projects on delete cascade,
  user_id uuid references profiles(id) on delete cascade,
  role text not null,
  unique(project_id, user_id)
);

-- Invitations
CREATE TABLE IF NOT EXISTS user_invitations (
  id bigint generated by default as identity primary key,
  email text not null,
  invited_by uuid references auth.users,
  created_at timestamp with time zone default timezone('utc'::text, now()) not null,
  status text default 'pending'
);

-- Invoices
CREATE TABLE IF NOT EXISTS invoices (
  id bigint generated by default as identity primary key,
  created_at timestamp with time zone default timezone('utc'::text, now()) not null,
  user_id uuid references auth.users not null,
  project_id bigint references projects(id),
  ico text,
  company_name text,
  bank_account text,
  iban text,
  amount_with_vat numeric,
  amount_without_vat numeric,
  currency text,
  confidence float,
  raw_text text
);

-- 4. ADD MISSING COLUMNS (Safe Updates)

DO $$ 
BEGIN
    ALTER TABLE profiles ADD COLUMN IF NOT EXISTS invited_by uuid references auth.users;
EXCEPTION 
    WHEN others THEN null;
END $$;

DO $$ 
BEGIN
    ALTER TABLE projects ADD COLUMN IF NOT EXISTS created_by uuid references auth.users;
    ALTER TABLE projects ADD COLUMN IF NOT EXISTS currency text default 'CZK';
EXCEPTION 
    WHEN others THEN null;
END $$;

DO $$ 
BEGIN
    ALTER TABLE user_invitations ADD COLUMN IF NOT EXISTS target_role text;
    ALTER TABLE user_invitations ADD COLUMN IF NOT EXISTS target_project_id bigint;
EXCEPTION 
    WHEN others THEN null;
END $$;

-- 5. ENABLE ROW LEVEL SECURITY
ALTER TABLE profiles ENABLE ROW LEVEL SECURITY;
ALTER TABLE projects ENABLE ROW LEVEL SECURITY;
ALTER TABLE budgets ENABLE ROW LEVEL SECURITY;
ALTER TABLE project_assignments ENABLE ROW LEVEL SECURITY;
ALTER TABLE user_invitations ENABLE ROW LEVEL SECURITY;
ALTER TABLE invoices ENABLE ROW LEVEL SECURITY;

-- 6. FAIL-SAFE FUNCTION (Role Claiming)
CREATE OR REPLACE FUNCTION claim_invited_role()
RETURNS text AS $$
DECLARE
  inv_record record;
  current_email text;
BEGIN
  -- Security Definer gives this function admin rights
  SET search_path = public, auth;
  
  SELECT lower(email) INTO current_email FROM auth.users WHERE id = auth.uid();
  
  -- Find the Pending Invitation
  SELECT * FROM public.user_invitations 
  WHERE lower(email) = current_email AND status = 'pending'
  LIMIT 1 INTO inv_record;

  IF inv_record.id IS NOT NULL THEN
    -- Link the inviter
    UPDATE public.profiles SET invited_by = inv_record.invited_by WHERE id = auth.uid();
    
    -- Assign Role
    IF inv_record.target_role IS NULL THEN
       -- No target role means it was a Superuser invite from Master
       UPDATE public.profiles SET is_superuser = true WHERE id = auth.uid();
    ELSE
       -- Has target role means it was a Team Member invite
       UPDATE public.profiles SET is_superuser = false WHERE id = auth.uid();
       
       -- Assign to Project
       IF inv_record.target_project_id IS NOT NULL THEN
          INSERT INTO public.project_assignments (project_id, user_id, role)
          VALUES (inv_record.target_project_id, auth.uid(), inv_record.target_role)
          ON CONFLICT DO NOTHING;
       END IF;
    END IF;

    -- Mark invite as used
    UPDATE public.user_invitations SET status = 'accepted' WHERE id = inv_record.id;
    RETURN 'Role Claimed: ' || coalesce(inv_record.target_role, 'Superuser');
  ELSE
    RETURN 'No pending invitation found';
  END IF;
END;
$$ LANGUAGE plpgsql SECURITY DEFINER;

-- 7. RLS POLICIES

-- PROJECTS
DROP POLICY IF EXISTS "Master manages all projects" ON projects;
CREATE POLICY "Master manages all projects" ON projects FOR ALL TO authenticated
USING ( lower(auth.jwt() ->> 'email') = 'tadekus@gmail.com' );

DROP POLICY IF EXISTS "Superusers manage own projects" ON projects;
CREATE POLICY "Superusers manage own projects" ON projects FOR ALL TO authenticated
USING ( created_by = auth.uid() );

DROP POLICY IF EXISTS "Team reads assigned projects" ON projects;
CREATE POLICY "Team reads assigned projects" ON projects FOR SELECT TO authenticated
USING ( EXISTS (SELECT 1 FROM project_assignments WHERE user_id = auth.uid() AND project_id = projects.id) );

-- BUDGETS
DROP POLICY IF EXISTS "Master manages all budgets" ON budgets;
CREATE POLICY "Master manages all budgets" ON budgets FOR ALL TO authenticated
USING ( lower(auth.jwt() ->> 'email') = 'tadekus@gmail.com' );

DROP POLICY IF EXISTS "Creators manage budgets" ON budgets;
CREATE POLICY "Creators manage budgets" ON budgets FOR ALL TO authenticated
USING ( EXISTS ( SELECT 1 FROM projects WHERE id = budgets.project_id AND created_by = auth.uid() ) );

-- PROFILES
DROP POLICY IF EXISTS "View related profiles" ON profiles;
CREATE POLICY "View related profiles" ON profiles FOR SELECT TO authenticated
USING ( 
   lower(auth.jwt() ->> 'email') = 'tadekus@gmail.com'
   OR invited_by = auth.uid()
   OR id = auth.uid()
   OR invited_by = (SELECT invited_by FROM profiles WHERE id = auth.uid())
);

DROP POLICY IF EXISTS "Master updates profiles" ON profiles;
CREATE POLICY "Master updates profiles" ON profiles FOR UPDATE TO authenticated
USING ( lower(auth.jwt() ->> 'email') = 'tadekus@gmail.com' );

-- INVITATIONS
DROP POLICY IF EXISTS "Master manages all invites" ON user_invitations;
CREATE POLICY "Master manages all invites" ON user_invitations FOR ALL TO authenticated
USING ( lower(auth.jwt() ->> 'email') = 'tadekus@gmail.com' );

DROP POLICY IF EXISTS "Users manage own sent invites" ON user_invitations;
CREATE POLICY "Users manage own sent invites" ON user_invitations FOR ALL TO authenticated
USING ( invited_by = auth.uid() );

DROP POLICY IF EXISTS "Read own received invitation" ON user_invitations;
CREATE POLICY "Read own received invitation" ON user_invitations FOR SELECT TO authenticated
USING ( lower(email) = lower(auth.jwt() ->> 'email') );

-- 8. MASTER USER OVERRIDE
UPDATE profiles SET is_superuser = true WHERE lower(email) = 'tadekus@gmail.com';
```